<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <title>Lottery Service</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        /* ìƒë‹¨ ë°” */
        .topbar {
          position: sticky;
          top: 0;
          display: flex;
          align-items: center;
          justify-content: center; /* ê°€ìš´ë° ì œëª© */
          height: 56px;
          border-bottom: 1px solid #eee;
          background: #fff;
          font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
        }
        .title { font-weight: 700; }

        /* ìš°ìƒë‹¨ ë²„íŠ¼ ì˜ì—­ */
        .actions {
          position: absolute;
          right: 16px;
          top: 8px;
          height: 40px;
          display: flex;
          align-items: center;
          gap: 8px;
        }
        button {
          border: 1px solid #ddd;
          background: #fafafa;
          padding: 8px 14px;
          border-radius: 8px;
          cursor: pointer;
        }
        button:hover { background: #f0f0f0; }

        /* ë³¸ë¬¸ ì˜ˆì‹œ */
        .container {
          max-width: 960px;
          margin: 24px auto;
          padding: 0 16px;
          color: #333;
        }
        .muted { color: #888; font-size: 14px; }
    </style>
</head>
<body>
<header class="topbar">
    <div class="title">Lottery Service</div>
    <div class="actions">
        <button id="authButton">Login</button>
    </div>
</header>

<main class="container">
    <h2>ë©”ì¸ í˜ì´ì§€</h2>
    <p class="muted">ë¡œê·¸ì¸ ì „/í›„ì— ìƒë‹¨ ìš°ì¸¡ ë²„íŠ¼ë§Œ ë°”ë€Œê³ , ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ ì‹œ ë©”ì¸ìœ¼ë¡œ ëŒì•„ì˜µë‹ˆë‹¤.</p>
</main>

<script>
    // ğŸ‘‰ í•„ìš” ì‹œ /login ëŒ€ì‹  íŠ¹ì • ì†Œì…œ ë¡œê·¸ì¸ ì—”ë“œí¬ì¸íŠ¸ë¡œ ë°”ë¡œ ë³´ë‚´ê³  ì‹¶ë‹¤ë©´ ì•„ë˜ë¥¼ êµì²´
    // ì˜ˆ: ì¹´ì¹´ì˜¤ë§Œ ì“¸ê±°ë©´ const loginUrl = '/oauth2/authorization/kakao';
    const loginUrl = '/login';
    const meUrl = '/api/me';

    const authBtn = document.getElementById('authButton');

    // ì¿ í‚¤ì—ì„œ XSRF-TOKEN êº¼ë‚´ê¸° (CookieCsrfTokenRepository ì‚¬ìš© ì‹œ)
    function getCsrfTokenFromCookie() {
      const m = document.cookie.match(/(?:^|;\s*)XSRF-TOKEN=([^;]*)/);
      return m ? decodeURIComponent(m[1]) : null;
    }

    async function refreshAuthState() {
      try {
        const res = await fetch(meUrl, { credentials: 'same-origin' });
        const data = await res.json();
        const isAuthed = !!data.authenticated;
        authBtn.textContent = isAuthed ? 'Logout' : 'Login';
        authBtn.dataset.state = isAuthed ? 'logout' : 'login';
      } catch (e) {
        // ì‹¤íŒ¨ ì‹œ ë¡œê·¸ì¸ í•„ìš”í•˜ë‹¤ê³  ë³´ê³  ë²„íŠ¼ì€ ë¡œê·¸ì¸ìœ¼ë¡œ
        authBtn.textContent = 'Login';
        authBtn.dataset.state = 'login';
      }
    }

    authBtn.addEventListener('click', async () => {
      const state = authBtn.dataset.state;
      if (state === 'login') {
        // ë¡œê·¸ì¸ í™”ë©´ìœ¼ë¡œ ì´ë™(ì„±ê³µ ì‹œ Security ì„¤ì •ì— ë”°ë¼ "/"ë¡œ ë³µê·€)
        window.location.href = loginUrl;
      } else {
        // ë¡œê·¸ì•„ì›ƒ: POST /logout + CSRF í—¤ë”
        const token = getCsrfTokenFromCookie();
        await fetch('/logout', {
          method: 'POST',
          credentials: 'same-origin',
          headers: { 'X-XSRF-TOKEN': token || '' }
        });
        // ë©”ì¸ìœ¼ë¡œ ë³µê·€
        window.location.href = '/';
      }
    });

    // ì²« ì§„ì… ì‹œ ìƒíƒœ ë™ê¸°í™”
    refreshAuthState();
</script>
</body>
</html>
